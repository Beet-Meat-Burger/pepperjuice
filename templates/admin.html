<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Dashboard</title>
  <script>
    function checkIfFileSelected(){
        const fileInput = document.getElementById('jsonFile');
        if (fileInput.value) {
            uploadJSON1()
        }else {
            setTimeout(checkIfFileSelected, 100)
        }
    }
    function uploadJSON(){
        const fileInput = document.getElementById('jsonFile');
        fileInput.value = ""
        fileInput.click()
        setTimeout(checkIfFileSelected, 100)
    }
    async function uploadJSON1() {
      const fileInput = document.getElementById('jsonFile');
      
      const file = fileInput.files[0];

      if (!file) {
        alert("Please select a JSON file.");
        return;
      }

      try {
        const text = await file.text();
        const jsonData = JSON.parse(text);

        const response = await fetch('/upload', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(jsonData)
        });

        alert("Uploaded bowl file from " + fileInput.value + ".")
      } catch (error) {
        console.error("Error reading or uploading file:", error);
        alert("Invalid JSON or upload error.");
      }
    }
  </script>
        <script>
            var isFullWidthLayout = false
          function toggleLayout() {
            isFullWidthLayout = !isFullWidthLayout;
            
            const leaderboards = document.querySelector('.leaderboards');
            const matrix = document.querySelector('.matrix-container');
            const toggleBtn = document.getElementById('layoutToggle');
            
            if (isFullWidthLayout) {
                leaderboards.classList.add('full-width');
                matrix.classList.add('expanded');
                toggleBtn.textContent = 'üìä Compact View';
            } else {
                leaderboards.classList.remove('full-width');
                matrix.classList.remove('expanded');
                toggleBtn.textContent = 'üñ•Ô∏è Full Width View';
            }
        }  
      </script>
  <style>
    /* Book / Regular (weight 400) */
    @font-face {
      font-family: "Whitney";
      src: url("/fonts/whitneybook.otf") format("opentype");
      font-weight: 400;
      font-style: normal;
      font-display: swap;
    }

    /* Bold (weight 700) */
    @font-face {
      font-family: "Whitney";
      src: url("/fonts/whitneybold.otf") format("opentype");
      font-weight: 700;
      font-style: normal;
      font-display: swap;
    }

    :root {
      --bg: #fcfaf3;
      --ink: #000;
      --brand: #8d312d;
      --choice: #EDE3B7;
      --warn: #ffc107;
      --ok: #1f7a1f;
      --err: #b00020;
      --muted: #666;
      --sidebar-bg: #f9f7f1;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Whitney", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background-color: var(--bg);
      color: var(--ink);
      min-height: 100vh;
    }
    .header {
      background-color: var(--brand);
      color: white;
      padding: 16px 20px;
      font-size: 24px;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    .logo { height: 40px; vertical-align: middle; }
    .admin-container {
      display: flex;
      min-height: calc(100vh - 65px);
    }
    .sidebar {
      width: 240px;
      background: var(--sidebar-bg);
      border-radius: 0 20px 20px 0;
      padding: 25px 15px;
      box-shadow: 2px 0 10px rgba(0,0,0,0.05);
    }
    .nav-item {
      display: block;
      padding: 12px 20px;
      margin: 5px 0;
      border-radius: 12px;
      text-decoration: none;
      color: var(--ink);
      font-weight: 500;
      transition: background 0.2s ease;
    }
    .nav-item:hover {
      background: var(--choice);
    }
    .nav-item.active {
      background: var(--brand);
      color: white;
    }
    .content {
      padding: 30px 20px;
      max-width: 1400px;
      margin: 0 auto;
      width: 100%;
    }
    
    .question { font-size: 26px; margin: 14px 0 18px; text-align: center; }
    .choice {
      display: block;
      width: 100%;
      max-width: 900px;
      text-align: left;
      background: var(--choice);
      border: none;
      padding: 14px 12px;
      margin: 10px auto;
      font-size: 20px;
      cursor: default;
      transition: transform .06s ease, background .2s ease, color .2s ease, box-shadow .2s ease;
      border-radius: 12px;
      position: relative;
    }
    .choice.correct { 
      background: var(--ok) !important; 
      color: #fff !important; 
      font-weight: bold;
    }
    .choice.correct::after {
      content: "‚úì CORRECT";
      position: absolute;
      right: 15px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 14px;
      font-weight: bold;
    }
    .teamID { font-size: 16px; margin-bottom: 12px; color: var(--muted); text-align: center; }
    .indicator {
      width: 12px; height: 12px; border-radius: 50%;
      display: inline-block; margin: 8px auto 0; border: 1px solid #0002;
    }
    .blink { animation: blink .6s ease-in-out; }
    .green { background-color: var(--ok); }
    .red { background-color: var(--err); }
    @keyframes blink { 0%{opacity:.25} 50%{opacity:1} 100%{opacity:.25} }

    .page-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 25px;
      padding-bottom: 15px;
      border-bottom: 1px solid #0002;
    }
    .page-title {
      font-size: 28px;
      color: var(--ink);
      margin: 0;
    }
    .form-group {
      margin-bottom: 20px;
    }
    .form-group label {
      display: block;
      font-size: 16px;
      margin-bottom: 8px;
      color: var(--ink);
    }
    .form-control {
      width: 100%;
      max-width: 500px;
      padding: 12px 15px;
      border-radius: 12px;
      border: 1px solid #0002;
      font-size: 16px;
      background: white;
      font-family: "Whitney", sans-serif;
    }
    .btn {
      background: var(--brand); 
      color: #fff; 
      border: none; 
      padding: 12px 24px;
      border-radius: 12px; 
      font-size: 16px; 
      cursor: pointer;
      font-weight: 500;
      transition: background 0.2s ease;
    }
    .btn:hover {
      background: #a03d39;
    }
    .btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .dashboard-cards {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    .card {
      background: white;
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.05);
      border: 1px solid #0002;
    }
    .card-header {
      display: flex;
      align-items: center;
      margin-bottom: 15px;
    }
    .card-icon {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      background: var(--choice);
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 12px;
      color: var(--brand);
      font-weight: bold;
    }
    .card-title {
      font-size: 18px;
      margin: 0;
      color: var(--ink);
    }
    .card-value {
      font-size: 28px;
      font-weight: bold;
      margin: 8px 0;
      color: var(--brand);
    }
    .card-desc {
      color: var(--muted);
      font-size: 14px;
      margin: 0;
    }
    .form-row {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
    }
    .center { text-align: center; }
    .question-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 10px 0;
      padding: 10px;
      background: #f9f7f1;
      border-radius: 8px;
      font-size: 14px;
      color: var(--muted);
    }
    .flag-indicator {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      color: var(--warn);
      font-weight: bold;
    }

    /* NEW STYLES FOR DATA VISUALIZATION */
    .leaderboards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .leaderboard {
      background: white;
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.05);
      border: 1px solid #0002;
    }
    
    .leaderboard-title {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 15px;
      color: var(--brand);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .leaderboard-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
      margin: 5px 0;
      border-radius: 8px;
      background: #f9f9f9;
    }
    
    .leaderboard-rank {
      font-weight: bold;
      color: var(--brand);
      min-width: 30px;
    }
    
    .leaderboard-team {
      flex: 1;
      margin: 0 10px;
    }
    
    .leaderboard-value {
      font-weight: bold;
      color: var(--ink);
    }
    
    .matrix-container {
      background: white;
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.05);
      border: 1px solid #0002;
      overflow-x: auto;
    }
    
    .matrix-controls {
      margin-bottom: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
    }
    
    .matrix-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      min-width: 800px;
    }
    
    .matrix-table th,
    .matrix-table td {
      border: 1px solid #ddd;
      padding: 6px;
      text-align: center;
    }
    
    .matrix-table th {
      background: var(--brand);
      color: white;
      font-weight: bold;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    
    .matrix-table .team-header {
      background: var(--choice);
      font-weight: bold;
      text-align: left;
      padding: 8px;
      position: sticky;
      left: 0;
      z-index: 5;
      min-width: 200px;
    }
    
    .matrix-table .team-stats {
      font-size: 10px;
      color: var(--muted);
    }
    
    .matrix-cell {
      width: 25px;
      height: 25px;
      border-radius: 4px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      margin: 2px;
      font-weight: bold;
      font-size: 10px;
      color: white;
      text-shadow: 1px 1px 1px rgba(0,0,0,0.3);
    }
    
    .matrix-cell.correct {
      background: var(--ok);
    }
    
    .matrix-cell.incorrect {
      background: var(--err);
    }
    
    .matrix-cell.unanswered {
      background: #ddd;
      color: #666;
      text-shadow: none;
    }
    
    .btn-secondary {
      background: #666;
      color: white;
    }
    
    .btn-secondary:hover {
      background: #555;
    }

    @media (max-width: 768px) {
      .admin-container { flex-direction: column; }
      .sidebar {
        width: 100%;
        border-radius: 20px 20px 0 0;
        padding: 15px;
        position: relative;
      }
      .sidebar .nav-item {
        display: inline-block;
        margin: 5px;
      }
      .leaderboards {
        grid-template-columns: 1fr;
      }
      
    }
    /* Add these new classes for layout toggle */
/* Layout toggle styles - more specific overrides */
.leaderboards.full-width {
  grid-template-columns: 1fr 1fr 1fr 1fr !important;
  margin-bottom: 10px !important;
  gap: 10px !important;
}

.leaderboards.full-width .leaderboard {
  padding: 10px !important;
  min-height: auto;
}

.leaderboards.full-width .leaderboard-title {
  font-size: 14px !important;
  margin-bottom: 8px !important;
}

.leaderboards.full-width .leaderboard-item {
  padding: 4px 6px !important;
  margin: 2px 0 !important;
  font-size: 12px;
}

.matrix-container.expanded {
  height: 70vh !important;
  min-height: 500px !important;
}

.matrix-container.expanded > div:last-child {
  height: calc(100% - 80px) !important;
  overflow-y: auto;
}

.layout-toggle {
  background: var(--choice) !important;
  color: var(--ink) !important;
  border: 2px solid var(--brand) !important;
}

.layout-toggle:hover {
  background: var(--brand) !important;
  color: white !important;
}

/* Mobile responsiveness for full-width */
@media (max-width: 1200px) {
  .leaderboards.full-width {
    grid-template-columns: 1fr 1fr !important;
  }
}

@media (max-width: 768px) {
  .leaderboards.full-width {
    grid-template-columns: 1fr !important;
  }
}

  </style>
</head>
<body>
  <div class="header">
    <img src="/static/logo.png" alt="Logo" class="logo" />
    Pepperjuice Platform
  </div>
  <div class="admin-container">
    <div class="sidebar" id="sidebar"></div>
    <div class="content" id="content"></div>
  </div>

<script src="/static/socketio.js"></script>
<script>
// =============================================================================
// ADMIN DASHBOARD WITH COMPLETE FUNCTIONALITY
// =============================================================================
// Add this new function


if (!localStorage.getItem("code")) {
    var value = ""
    while(!value) {
        value = prompt("Enter your password. If it is wrong, functions may not work.")
    }
    localStorage.setItem("code", value)
}

(() => {
  const sidebar = document.getElementById("sidebar");
  const content = document.getElementById("content");
  const socket = io(); 
  window.socket = socket

  // Global state management
  let state = {
    currentView: 'dashboard',
    adminCode: localStorage.getItem("code"),
    currentQuestion: null,
    isPaused: false,
    teamsData: {}, // Store teams data here
    isFullWidthLayout: false
  };

  // =============================================================================
  // HARDWARE INDICATOR CONTROL
  // =============================================================================
  window.blinkLed = function(color) {
    const indicator = document.getElementById("indicator");
    if (indicator) {
      indicator.className = `indicator ${color} blink`;
      setTimeout(() => {
        indicator.className = `indicator ${color}`;
      }, 1200);
    }
  };

  // =============================================================================
  // SOCKET EVENT LISTENERS
  // =============================================================================
  function refreshTeamsData() {
    socket.emit('admin teams data', {"admin_code": state.adminCode}, (teamsData) => {
        console.log('Received teams data:', teamsData);
        state.teamsData = teamsData;
        
        // If we're currently viewing team results, refresh the view
        if (state.currentView === 'teams') {
        showTeamResults();
        }
    });
   }
   refreshTeamsData()
   window.refreshTeamsData = refreshTeamsData; 
  // =============================================================================
  // DATA PROCESSING FUNCTIONS
  // =============================================================================
  function getTeamsArray() {
    return Object.entries(state.teamsData).map(([teamId, teamData]) => ({
      id: teamId,
      ...teamData
    }));
  }

  function generateLeaderboard(teams, sortBy, title, icon, formatter) {
    const sorted = [...teams]
      .filter(team => team[sortBy] !== undefined)
      .sort((a, b) => b[sortBy] - a[sortBy])
      .slice(0, 10);

    return {
      title,
      icon,
      items: sorted.map((team, index) => ({
        rank: index + 1,
        team: `${team.team_number || team.id} ${team.country} - ${team.member1}  ${team.member2}  ${team.member3}`,
        value: formatter(team[sortBy])
      }))
    };
  }

  function generateMatrixData(teams) {
    // Get all unique question indices
    const allQuestions = new Set();
    teams.forEach(team => {
      if (team.questions) {
        Object.keys(team.questions).forEach(q => allQuestions.add(parseInt(q)));
      }
    });

    const questionNumbers = Array.from(allQuestions).sort((a, b) => a - b);

    return {
      teams: teams.map(team => ({
        id: team.id,
        name: `${team.team_number || team.id} ${team.country} - ${team.member1}  ${team.member2}  ${team.member3}`,
        score: team.score || 0,
        accuracy: team.accuracy || 0,
        streak: team.streak || 0,
        questions: team.questions || {}
      })),
      questionNumbers
    };
  }

  function exportToCSV() {
    const teams = getTeamsArray();
    const matrixData = generateMatrixData(teams);
    
    let csv = 'Team ID,Team Number,Score,Accuracy,Current Streak,High Streak';
    
    // Add question headers with choice and correctness columns
    matrixData.questionNumbers.forEach(qNum => {
      csv += `,Q${qNum + 1} Choice,Q${qNum + 1} Correct`;
    });
    csv += '\n';
    
    // Add team data
    matrixData.teams.forEach(team => {
      const teamData = teams.find(t => t.id === team.id);
      csv += `${team.id},${teamData?.team_number || ''},${team.score},${team.accuracy}%,${team.streak},${teamData?.highstreak || 0}`;
      
      matrixData.questionNumbers.forEach(qNum => {
        const questionData = team.questions[qNum];
        let choice = '';
        let isCorrect = '';
        
        if (questionData) {
          if (typeof questionData === 'object') {
            // New format with selected_choice and is_correct
            choice = questionData.selected_choice ? questionData.selected_choice.toUpperCase() : '';
            isCorrect = questionData.is_correct ? 'Yes' : 'No';
          } else {
            // Legacy format handling
            choice = 'Answered';
            isCorrect = '';
          }
        } else {
          choice = '';
          isCorrect = '';
        }
        
        csv += `,"${choice}","${isCorrect}"`;
      });
      csv += '\n';
    });
    
    // Download CSV
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `team_results_${new Date().toISOString().split('T')[0]}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
  }

  // =============================================================================
  // NAVIGATION SYSTEM
  // =============================================================================
  function navigateTo(view) {
    state.currentView = view;
    if (view == "teams") {
      refreshTeamsData()
    }
    renderSidebar();
    renderView();
  }

  function renderSidebar() {
    sidebar.innerHTML = `
      <a href="#" class="nav-item ${state.currentView === 'dashboard' ? 'active' : ''}" data-view="dashboard">
        üìä Dashboard
      </a>
      <a href="#" class="nav-item ${state.currentView === 'quiz' ? 'active' : ''}" data-view="quiz">
        üéØ Bowl Control
      </a>
      <a href="#" class="nav-item ${state.currentView === 'questions' ? 'active' : ''}" data-view="questions">
        ‚ùì Questions
      </a>
      <a href="#" class="nav-item ${state.currentView === 'teams' ? 'active' : ''}" data-view="teams">
        üë• Team Results
      </a>
      <a href="#" class="nav-item ${state.currentView === 'settings' ? 'active' : ''}" data-view="settings">
        ‚öôÔ∏è System
      </a>
    `;

    document.querySelectorAll('.nav-item').forEach(item => {
      item.addEventListener('click', (e) => {
        e.preventDefault();
        const view = item.getAttribute('data-view');
        navigateTo(view);
      });
    });
  }

  // =============================================================================
  // VIEW RENDERING
  // =============================================================================
  function renderView() {
    switch(state.currentView) {
      case 'dashboard': showDashboard(); break;
      case 'quiz': showQuizControl(); break;
      case 'questions': showQuestionsManagement(); break;
      case 'teams': showTeamResults(); break;
      case 'settings': showSystemSettings(); break;
      default: showDashboard();
    }
  }

  // =============================================================================
  // QUIZ CONTROL VIEW WITH REAL SERVER DATA (RESTORED ORIGINAL)
  // =============================================================================
  function showQuizControl() {
    content.innerHTML = `
        <div class="page-header">
        <h1 class="page-title">Bowl Control</h1>
        </div>
        
        <div class="form-row" style="margin-bottom: 25px; align-items: center;">
        <button id="pauseBtn" class="btn" style="width: auto; padding: 12px 24px;">
            ‚è∏Ô∏è Pause Bowl
        </button>
        <button id="prevBtn" class="btn" style="width: auto; padding: 12px 24px; background: #666;">
            ‚¨ÖÔ∏è Previous
        </button>
        <button id="nextBtn" class="btn" style="width: auto; padding: 12px 24px; background: #5d7c5d;">
            Next ‚û°Ô∏è
        </button>
        </div>
        
        <div class="card" style="margin-bottom: 25px;">
        <div class="card-header">
            <div class="card-icon">‚ùì</div>
            <h2 class="card-title">Current Question</h2>
        </div>
        <div id="questionMeta" class="question-meta">
            <span id="questionId">Loading...</span>
            <span id="flagCount" class="flag-indicator">üö© 0 flags</span>
        </div>
        <div class="question" id="questionText">Loading question from server...</div>
        <div id="pausedMessage" class="center" style="color: var(--err); min-height: 20px; margin: 15px 0; font-weight: bold;"></div>
        <div class="center" style="margin: 15px 0;">
            <span id="indicator" class="indicator"></span>
        </div>
        </div>
        
        <div class="card">
        <div class="card-header">
            <div class="card-icon">üìù</div>
            <h2 class="card-title">Answer Choices</h2>
        </div>
        <div id="choices" style="margin-top: 15px;">
            Loading choices...
        </div>
        </div>
    `;

    // Helper function to process the admin question data response
    function updateQuestionData(adminData) {
      state.currentQuestion = {
        id: adminData.id,
        text: adminData.text || adminData.question,
        choices: adminData.choices || [adminData.a, adminData.b, adminData.c, adminData.d, adminData.e].filter(c => c),
        correct_answer: adminData.correct_answer,
        number_of_flags: adminData.number_of_flags || 0
      };
      // CRITICAL FIX: Use the 'open' boolean to set pause state
      state.isPaused = !adminData.open; 
    }


    // Socket event listeners
    socket.on('quiz', (questionData) => {
        // When quiz resumes, request admin data immediately
        socket.emit('admin question data', { admin_code: state.adminCode }, (response) => {
        if (response) {
            updateQuestionData(response);
            updateQuizUI();
        }
        });
    });

    socket.on('quiz pause', () => {
        state.isPaused = true;
        updateQuizUI();
    });

    // Button event handlers
    document.getElementById('pauseBtn').addEventListener('click', () => {
        if (state.isPaused) {
        socket.emit('resume', { admin_code: state.adminCode });
        blinkLed('green');
        } else {
        socket.emit('pause', { admin_code: state.adminCode });
        blinkLed('red');
        }
    });

    document.getElementById('nextBtn').addEventListener('click', () => {
        socket.emit('increment', { 
        admin_code: state.adminCode, 
        forward: true 
        });
        setTimeout(() => {
        socket.emit('admin question data', { admin_code: state.adminCode }, (response) => {
            if (response) {
            updateQuestionData(response);
            updateQuizUI();
            }
        });
        }, 200);
    });

    document.getElementById('prevBtn').addEventListener('click', () => {
        socket.emit('increment', { 
        admin_code: state.adminCode, 
        forward: false 
        });
        setTimeout(() => {
        socket.emit('admin question data', { admin_code: state.adminCode }, (response) => {
            if (response) {
            updateQuestionData(response);
            updateQuizUI();
            }
        });
        }, 200);
    });

    // Initial data load
    socket.emit('admin question data', { admin_code: state.adminCode }, (response) => {
        if (response) {
        updateQuestionData(response);
        updateQuizUI();
        }
    });
  }

  function updateQuizUI() {
    const pauseBtn = document.getElementById('pauseBtn');
    const pausedMessage = document.getElementById('pausedMessage');
    const questionText = document.getElementById('questionText');
    const questionId = document.getElementById('questionId');
    const flagCount = document.getElementById('flagCount');
    const choicesElement = document.getElementById('choices');
    const indicator = document.getElementById('indicator');

    // Update pause button
    if (pauseBtn) {
      if (state.isPaused) {
        pauseBtn.innerHTML = '‚ñ∂Ô∏è Resume Bowl';
        pauseBtn.style.background = 'var(--ok)';
      } else {
        pauseBtn.innerHTML = '‚è∏Ô∏è Pause Bowl';
        pauseBtn.style.background = 'var(--err)';
      }
    }

    // Update paused message
    if (pausedMessage) {
      if (state.isPaused) {
        pausedMessage.textContent = '‚ö†Ô∏è Bowl is currently paused';
        pausedMessage.style.display = 'block';
      } else {
        pausedMessage.style.display = 'none';
      }
    }

    // Update indicator
    if (indicator) {
      indicator.className = `indicator ${state.isPaused ? 'red' : 'green'}`;
    }

    // Update question content
    if (state.currentQuestion) {
      if (questionText) {
        questionText.textContent = state.currentQuestion.text;
      }
      
      if (questionId) {
        questionId.textContent = `Question ID: ${state.currentQuestion.id}`;
      }
      
      // Update flag count
      if (flagCount) {
        const flags = state.currentQuestion.number_of_flags || 0;
        flagCount.textContent = `üö© ${flags} flag${flags !== 1 ? 's' : ''}`;
        flagCount.style.display = flags > 0 ? 'inline-flex' : 'none';
      }

      // Update choices with correct answer highlighting
      if (choicesElement && state.currentQuestion.choices) {
        choicesElement.innerHTML = '';
        
        const choices = state.currentQuestion.choices;
        const correctAnswer = state.currentQuestion.correct_answer;
        
        choices.forEach((choice, index) => {
          if (choice && choice.trim()) {
            const letter = String.fromCharCode(65 + index); // A, B, C, D, E
            const choiceBtn = document.createElement('div');
            choiceBtn.className = 'choice';
            
            // Mark correct answer
            if (correctAnswer && correctAnswer.toLowerCase() === letter.toLowerCase()) {
              choiceBtn.classList.add('correct');
            }
            
            choiceBtn.textContent = `${letter}. ${choice}`;
            choicesElement.appendChild(choiceBtn);
          }
        });
      }
    }
  }

  // =============================================================================
  // TEAM RESULTS VIEW WITH COMPREHENSIVE DATA VISUALIZATION INCLUDING CHOICES
  // =============================================================================
  function showTeamResults() {
    const teams = getTeamsArray();
    
    if (teams.length === 0) {
      content.innerHTML = `
        <div class="page-header">
          <h1 class="page-title">Team Results</h1>
          <button class="btn" onclick="refreshTeamsData()">
            üîÑ Refresh Data
          </button>
        </div>
        <div class="center" style="margin-top: 50px;">
          <p style="color: var(--muted); font-size: 18px;">No team data available</p>
          <button class="btn" onclick="refreshTeamsData()">
            Load Team Data
          </button>
        </div>
      `;
      return;
    }

    // Generate leaderboards
    const leaderboards = [
      generateLeaderboard(teams, 'score', 'Points Leaderboard', 'üèÜ', val => val),
      generateLeaderboard(teams, 'accuracy', 'Accuracy Leaderboard', 'üéØ', val => `${val}%`),
      generateLeaderboard(teams, 'streak', 'Current Streak', 'üî•', val => val),
      generateLeaderboard(teams, 'highstreak', 'Highest Streak', '‚≠ê', val => val)
    ];

    const matrixData = generateMatrixData(teams);

    content.innerHTML = `
      <div class="page-header">
        <h1 class="page-title">Team Results</h1>
        <div style="display: flex; gap: 10px;">
          <button class="btn" onclick="refreshTeamsData()">
            üîÑ Refresh Data
          </button>
          <button class="btn btn-secondary" onclick="exportToCSV()">
            üìÅ Export CSV
          </button>
          <button class="btn layout-toggle" id="layoutToggle" onclick="toggleLayout()">
            üñ•Ô∏è Full Width View
        </button>
        </div>
      </div>

      <!-- Leaderboards -->
      <div class="leaderboards">
        ${leaderboards.map(board => `
          <div class="leaderboard">
            <div class="leaderboard-title">
              ${board.icon} ${board.title}
            </div>
            ${board.items.map(item => `
              <div class="leaderboard-item">
                <span class="leaderboard-rank">#${item.rank}</span>
                <span class="leaderboard-team">${item.team}</span>
                <span class="leaderboard-value">${item.value}</span>
              </div>
            `).join('')}
            ${board.items.length === 0 ? '<p style="color: var(--muted); text-align: center;">No data yet</p>' : ''}
          </div>
        `).join('')}
      </div>

      <!-- Matrix View -->
      <div class="matrix-container">
        <div class="matrix-controls">
          <h2 style="margin: 0; color: var(--brand);">üìä Question Matrix with Choices</h2>
          <div style="display: flex; gap: 15px; align-items: center;">
            <div style="display: flex; gap: 10px; align-items: center; font-size: 12px;">
              <span style="display: flex; align-items: center; gap: 5px;">
                <div class="matrix-cell correct">A</div> Correct
              </span>
              <span style="display: flex; align-items: center; gap: 5px;">
                <div class="matrix-cell incorrect">B</div> Incorrect
              </span>
              <span style="display: flex; align-items: center; gap: 5px;">
                <div class="matrix-cell unanswered">-</div> Unanswered
              </span>
            </div>
          </div>
        </div>

        <div style="overflow-x: auto;">
          <table class="matrix-table">
            <thead>
              <tr>
                <th style="min-width: 200px;">Team</th>
                ${matrixData.questionNumbers.map(qNum => `<th>Q${qNum + 1}<br></th>`).join('')}
              </tr>
            </thead>
            <tbody>
              ${matrixData.teams.map(team => {
                const teamData = teams.find(t => t.id === team.id);
                return `
                  <tr>
                    <td class="team-header">
                      <div>${team.name}</div>
                      <div class="team-stats">
                        Score: ${team.score} | Accuracy: ${team.accuracy}% | Streak: ${team.streak}
                      </div>
                    </td>
                    ${matrixData.questionNumbers.map(qNum => {
                      const questionData = team.questions[qNum];
                      let cellClass = 'unanswered';
                      let selectedChoice = '';
                      let tooltipText = `${team.name} - Q${qNum + 1}: `;
                      
                      if (questionData) {
                        if (typeof questionData === 'object') {
                          // New format with selected_choice and is_correct
                          selectedChoice = questionData.selected_choice ? 
                            questionData.selected_choice.toUpperCase() : '?';
                          
                          cellClass = questionData.is_correct ? 'correct' : 'incorrect';
                          tooltipText += ` ${questionData.is_correct ? '‚úî' : '‚ùå'}`;
                        } else {
                          // Legacy format
                          selectedChoice = '‚úì';
                          cellClass = 'answered';
                          tooltipText += 'Answered (legacy format)';
                        }
                      } else {
                        selectedChoice = '-';
                        tooltipText += 'Not answered';
                      }
                      
                      return `
                        <td title="${tooltipText}">
                          <div class="matrix-cell ${cellClass}" onclick="jumpToQuestion(${qNum})">
                            ${selectedChoice}
                          </div>
                        </td>
                      `;
                    }).join('')}
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>
        </div>
      </div>
    `;

    // Make exportToCSV available globally
    window.exportToCSV = exportToCSV;

    // Request fresh data
    socket.emit('admin teams data', { admin_code: state.adminCode });
  }

  // =============================================================================
  // OTHER VIEWS (SIMPLIFIED FOR BREVITY)
  // =============================================================================
  function showDashboard() {
    content.innerHTML = `
      <div class="page-header">
        <h1 class="page-title">Admin Dashboard</h1>
      </div>
      
      <div class="dashboard-cards">
        <div class="card">
          <div class="card-header">
            <div class="card-icon">Q</div>
            <h2 class="card-title">Questions</h2>
          </div>
          <div class="card-value">Many</div>
          <p class="card-desc">Questions in bowl file</p>
        </div>
        
        <div class="card">
          <div class="card-header">
            <div class="card-icon">T</div>
            <h2 class="card-title">Live Teams</h2>
          </div>
          <div class="card-value">${Object.keys(state.teamsData).length}</div>
          <p class="card-desc">Teams currently active</p>
        </div>
        
        <div class="card">
          <div class="card-header">
            <div class="card-icon">üö©</div>
            <h2 class="card-title">Flagged Issues</h2>
          </div>
          <div class="card-value">None</div>
          <p class="card-desc">Pending review</p>
        </div>
      </div>
      
      <div class="page-header" style="margin-top: 40px;">
        <h2 class="page-title">Bowl</h2>
      </div>
      <div class="form-group">
        <input type="file" id="jsonFile" style="display: none" name="Bowl File" accept="application/json" />
        <button class="btn" onclick="uploadJSON()">Upload</button>
        <button class="btn" onclick="socket.emit('admin clear teams', {'admin_code': '${state.adminCode}'})">Clear User Data</button>
      </div>
    `;
  }

  function jumpToQuestion(questionNumber) {
    // Emit socket event to jump to question
    socket.emit('jump to question', {
      admin_code: state.adminCode,
      question_index: questionNumber
    }, (response) => {
        navigateTo('quiz');
    });
  };
  window.jumpToQuestion = jumpToQuestion

  function showQuestionsManagement() {
    content.innerHTML = `
      <div class="page-header">
        <h1 class="page-title">Question Management</h1>
      </div>
      <p class="center" style="color: var(--muted);"><a class="btn" href="/quizMaker">Bowl Maker</a></p>
    `;
  }

  function showSystemSettings() {
    content.innerHTML = `
      <div class="page-header">
        <h1 class="page-title">System Settings</h1>
      </div>
      <p class="center" style="color: var(--muted);"><button class="btn" onclick="localStorage.clear(); location.reload();">Log Out</button></p>
    `;
  }

  // =============================================================================
  // INITIALIZE UI
  // =============================================================================
  function initializeUI() {
    renderSidebar();
    renderView();
  }

  window.addEventListener("DOMContentLoaded", initializeUI);
})();
</script>
</body>
</html>
